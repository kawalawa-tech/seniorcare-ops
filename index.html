
<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>善頤護老 - OpsCentre</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@babel/standalone@7.24.0/babel.min.js"></script>
    
    <script>
        tailwind.config = {
          theme: {
            extend: {
              colors: {
                brand: {
                  orange: '#f97316',
                  blue: '#005ca8',
                  green: '#88bc4c',
                  slate: '#1e293b',
                  surface: '#f8fafc'
                }
              }
            }
          }
        }
        window.global = window;
    </script>

    <style>
        :root { 
            --brand-orange: #f97316; 
            --brand-blue: #005ca8;
            --brand-green: #88bc4c;
            --brand-slate: #1e293b;
        }
        
        html, body { height: 100vh; width: 100vw; margin: 0; padding: 0; overflow: hidden; background-color: #f8fafc; font-family: 'Noto Sans TC', 'Inter', sans-serif; }
        #root { height: 100%; width: 100%; }
        
        .brand-orange-bg { background-color: var(--brand-orange); }
        .brand-orange-text { color: var(--brand-orange); }
        .brand-blue-bg { background-color: var(--brand-blue); }
        .brand-blue-text { color: var(--brand-blue); }
        .brand-green-bg { background-color: var(--brand-green); }
        .brand-green-text { color: var(--brand-green); }
        .brand-slate-bg { background-color: var(--brand-slate); }
        .brand-slate-text { color: var(--brand-slate); }

        .loader-container { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; gap: 1.5rem; text-align: center; padding: 20px; }
        .loader { width: 40px; height: 40px; border: 4px solid #f1f5f9; border-top: 4px solid var(--brand-orange); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .error-box { background: white; padding: 2rem; border-radius: 2rem; box-shadow: 0 20px 50px rgba(0,0,0,0.1); max-width: 400px; width: 100%; border: 1px solid #fee2e2; }
        .btn-reset { margin-top: 1.5rem; background: #1e293b; color: white; padding: 0.75rem 1.5rem; border-radius: 1rem; font-weight: 800; font-size: 12px; cursor: pointer; border: none; transition: all 0.2s; }
        .btn-reset:hover { background: #f43f5e; transform: scale(1.05); }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #cbd5e1; }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.3.1",
        "react-dom": "https://esm.sh/react-dom@18.3.1",
        "react-dom/client": "https://esm.sh/react-dom@18.3.1/client",
        "react/jsx-runtime": "https://esm.sh/react@18.3.1/jsx-runtime",
        "lucide-react": "https://esm.sh/lucide-react@0.468.0?deps=react@18.3.1",
        "recharts": "https://esm.sh/recharts@2.12.7?deps=react@18.3.1",
        "@google/genai": "https://esm.sh/@google/genai@1.3.0",
        "react/": "https://esm.sh/react@18.3.1/",
        "react-dom/": "https://esm.sh/react-dom@18.3.1/"
      }
    }
    </script>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <div id="root">
        <div class="loader-container">
            <div id="loading-spinner" class="loader"></div>
            <div id="error-display" style="display:none" class="error-box">
                <div style="color:#f43f5e; font-size:24px; margin-bottom:1rem">⚠️</div>
                <p id="status-text" style="font-size: 14px; font-weight: 800; color: #1e293b; margin-bottom: 0.5rem;"></p>
                <p id="error-details" style="font-size: 10px; color: #94a3b8; font-weight: 400; line-height: 1.6;"></p>
                <button class="btn-reset" onclick="handleEmergencyReset()">強制重置系統 (清空快取)</button>
            </div>
            <div id="boot-info">
                <p style="font-size: 11px; font-weight: 800; color: #cbd5e1; letter-spacing: 0.15em; text-transform: uppercase;">
                    SeniorCare OpsCentre<br>
                    <span id="loading-subtext" style="font-weight: 400; opacity: 0.6; font-size: 9px;">Assembling Operations...</span>
                </p>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        const rawSources = {};
        const blobUrls = {};

        function handleEmergencyReset() {
            if (confirm("這將清除所有未同步到雲端的本地資料，並嘗試重新載入。確定嗎？")) {
                localStorage.clear();
                window.location.reload();
            }
        }

        function resolvePath(basePath, relPath) {
            if (!relPath.startsWith('.')) return relPath;
            const cleanRelPath = relPath.replace(/\.(tsx?)$/, '');
            const baseParts = basePath.split('/').slice(0, -1);
            const relParts = cleanRelPath.split('/');
            const finalParts = [...baseParts];
            for (const part of relParts) {
                if (part === '..') finalParts.pop();
                else if (part !== '.') finalParts.push(part);
            }
            const finalPath = finalParts.join('/');
            if (rawSources[finalPath + '.tsx']) return finalPath + '.tsx';
            if (rawSources[finalPath + '.ts']) return finalPath + '.ts';
            if (rawSources[finalPath]) return finalPath;
            return finalPath;
        }

        async function compileFile(filePath) {
            if (blobUrls[filePath]) return blobUrls[filePath];
            let content = rawSources[filePath];
            if (!content) throw new Error(`找不到檔案: "${filePath}"`);
            
            const importRegex = /(from|import)\s+['"](\.\.?\/[^'"]+)['"]/g;
            const matches = [...content.matchAll(importRegex)];
            for (const match of matches) {
                const relPath = match[2];
                const absPath = resolvePath(filePath, relPath);
                if (rawSources[absPath]) {
                    const childBlobUrl = await compileFile(absPath);
                    content = content.split(match[0]).join(`${match[1]} "${childBlobUrl}"`);
                }
            }
            try {
                const transformed = Babel.transform(content, {
                    presets: ['react', 'typescript'],
                    filename: filePath
                }).code;
                const blob = new Blob([transformed], { type: 'application/javascript' });
                const url = URL.createObjectURL(blob);
                blobUrls[filePath] = url;
                return url;
            } catch (babelErr) {
                throw new Error(`編譯錯誤 [${filePath}]: ${babelErr.message}`);
            }
        }

        async function init() {
            const subtext = document.getElementById('loading-subtext');
            const filesToFetch = [
                'types.ts', 'constants.tsx', 
                'services/gemini.ts', 'services/cloudStorage.ts',
                'components/Sidebar.tsx', 'components/Dashboard.tsx', 'components/TaskBoard.tsx',
                'components/CalendarView.tsx', 'components/Analytics.tsx', 'components/NotesView.tsx',
                'components/ImportantDocsView.tsx', 'components/AIAssistant.tsx', 'components/TaskModal.tsx',
                'components/DocModal.tsx', 'App.tsx', 'index.tsx'
            ];
            
            try {
                if (subtext) subtext.innerText = "Connecting to Facility...";
                await Promise.all(filesToFetch.map(async (f) => {
                    const r = await fetch(f);
                    if (!r.ok) throw new Error(`無法下載核心組件: ${f}`);
                    rawSources[f] = await r.text();
                }));
                
                if (subtext) subtext.innerText = "Synchronizing Components...";
                const entryPointUrl = await compileFile('index.tsx');
                
                if (subtext) subtext.innerText = "Welcome Back.";
                const script = document.createElement('script');
                script.type = 'module';
                script.src = entryPointUrl;
                document.head.appendChild(script);
                console.log("OpsCentre: Boot Successful.");
            } catch (err) {
                console.error("OpsCentre Critical Boot Failure:", err);
                document.getElementById('loading-spinner').style.display = 'none';
                document.getElementById('boot-info').style.display = 'none';
                
                const errorDisplay = document.getElementById('error-display');
                const statusText = document.getElementById('status-text');
                const errorDetails = document.getElementById('error-details');
                
                if (errorDisplay) {
                    errorDisplay.style.display = 'block';
                    statusText.innerText = "啟動程序中斷";
                    errorDetails.innerText = err.message || "發生未知錯誤，請嘗試重置系統。";
                }
            }
        }
        window.addEventListener('load', init);
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
