<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>善頤護老 - OpsCentre</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@babel/standalone@7.24.0/babel.min.js"></script>
    
    <script>
        // Tailwind Configuration for SeniorCare Brand
        tailwind.config = {
          theme: {
            extend: {
              colors: {
                brand: {
                  orange: '#f97316',
                  blue: '#005ca8',
                  green: '#88bc4c',
                  slate: '#1e293b',
                  surface: '#f8fafc'
                }
              }
            }
          }
        }
        
        window.process = { env: { API_KEY: "" } };
        window.global = window;
    </script>

    <style>
        :root { 
            --brand-orange: #f97316; 
            --brand-blue: #005ca8;
            --brand-green: #88bc4c;
            --brand-slate: #1e293b;
        }
        
        html, body { height: 100vh; width: 100vw; margin: 0; padding: 0; overflow: hidden; background-color: #f8fafc; font-family: 'Noto Sans TC', 'Inter', sans-serif; }
        #root { height: 100%; width: 100%; }
        
        /* Brand Utility Classes */
        .brand-orange-bg { background-color: var(--brand-orange); }
        .brand-orange-text { color: var(--brand-orange); }
        .brand-blue-bg { background-color: var(--brand-blue); }
        .brand-blue-text { color: var(--brand-blue); }
        .brand-green-bg { background-color: var(--brand-green); }
        .brand-green-text { color: var(--brand-green); }
        .brand-slate-bg { background-color: var(--brand-slate); }
        .brand-slate-text { color: var(--brand-slate); }

        /* Loader */
        .loader-container { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; gap: 1.5rem; text-align: center; }
        .loader { width: 32px; height: 32px; border: 3px solid #f1f5f9; border-top: 3px solid var(--brand-orange); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Scrollbars */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #cbd5e1; }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.3.1",
        "react-dom": "https://esm.sh/react-dom@18.3.1",
        "react-dom/client": "https://esm.sh/react-dom@18.3.1/client",
        "react/jsx-runtime": "https://esm.sh/react@18.3.1/jsx-runtime",
        "lucide-react": "https://esm.sh/lucide-react@0.468.0?deps=react@18.3.1",
        "recharts": "https://esm.sh/recharts@2.12.7?deps=react@18.3.1",
        "@google/genai": "https://esm.sh/@google/genai@1.3.0",
        "react/": "https://esm.sh/react@18.3.1/",
        "react-dom/": "https://esm.sh/react-dom@18.3.1/"
      }
    }
    </script>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <div id="root">
        <div class="loader-container">
            <div class="loader"></div>
            <p id="status-text" style="font-size: 11px; font-weight: 800; color: #cbd5e1; letter-spacing: 0.15em; text-transform: uppercase;">
                SeniorCare OpsCentre<br>
                <span id="loading-subtext" style="font-weight: 400; opacity: 0.6; font-size: 9px;">Assembling Operations...</span>
            </p>
        </div>
    </div>

    <script type="text/javascript">
        const rawSources = {};
        const blobUrls = {};

        // Robust Path Resolver
        function resolvePath(basePath, relPath) {
            if (!relPath.startsWith('.')) return relPath;
            
            // Remove optional extension from relPath for easier matching
            const cleanRelPath = relPath.replace(/\.(tsx?)$/, '');
            
            const baseParts = basePath.split('/').slice(0, -1);
            const relParts = cleanRelPath.split('/');
            
            const finalParts = [...baseParts];
            for (const part of relParts) {
                if (part === '..') finalParts.pop();
                else if (part !== '.') finalParts.push(part);
            }
            
            const finalPath = finalParts.join('/');
            // Check for potential source file matches
            if (rawSources[finalPath + '.tsx']) return finalPath + '.tsx';
            if (rawSources[finalPath + '.ts']) return finalPath + '.ts';
            if (rawSources[finalPath]) return finalPath; // Case where file is registered without extension
            
            return finalPath;
        }

        // Recursive Module Compiler
        async function compileFile(filePath) {
            if (blobUrls[filePath]) return blobUrls[filePath];
            
            let content = rawSources[filePath];
            if (!content) throw new Error(`Missing source for "${filePath}"`);

            // Improved regex to find all import/export from statements
            const importRegex = /(from|import)\s+['"](\.\.?\/[^'"]+)['"]/g;
            const matches = [...content.matchAll(importRegex)];
            
            // Compile dependencies first
            for (const match of matches) {
                const relPath = match[2];
                const absPath = resolvePath(filePath, relPath);
                
                if (rawSources[absPath]) {
                    const childBlobUrl = await compileFile(absPath);
                    // Global replacement for this specific import path
                    content = content.split(match[0]).join(`${match[1]} "${childBlobUrl}"`);
                }
            }

            try {
                const transformed = Babel.transform(content, {
                    presets: ['react', 'typescript'],
                    filename: filePath
                }).code;

                const blob = new Blob([transformed], { type: 'application/javascript' });
                const url = URL.createObjectURL(blob);
                blobUrls[filePath] = url;
                return url;
            } catch (babelErr) {
                console.error(`Babel Error in ${filePath}:`, babelErr);
                throw babelErr;
            }
        }

        async function init() {
            const subtext = document.getElementById('loading-subtext');
            const filesToFetch = [
                'types.ts', 'constants.tsx', 
                'services/gemini.ts', 'services/cloudStorage.ts',
                'components/Sidebar.tsx', 'components/Dashboard.tsx', 'components/TaskBoard.tsx',
                'components/CalendarView.tsx', 'components/Analytics.tsx', 'components/NotesView.tsx',
                'components/ImportantDocsView.tsx', 'components/AIAssistant.tsx', 'components/TaskModal.tsx',
                'components/DocModal.tsx', 'App.tsx', 'index.tsx'
            ];

            try {
                subtext.innerText = "Connecting to Facility...";
                await Promise.all(filesToFetch.map(async (f) => {
                    const r = await fetch(f);
                    if (!r.ok) throw new Error(`Fetch failed for ${f}`);
                    rawSources[f] = await r.text();
                }));

                subtext.innerText = "Synchronizing Components...";
                const entryPointUrl = await compileFile('index.tsx');

                subtext.innerText = "Welcome Back.";
                const script = document.createElement('script');
                script.type = 'module';
                script.src = entryPointUrl;
                document.head.appendChild(script);

                console.log("OpsCentre: Boot Successful.");
            } catch (err) {
                console.error("OpsCentre Critical Boot Failure:", err);
                const statusText = document.getElementById('status-text');
                statusText.innerHTML = `<span style="color:#f43f5e; font-weight:800">SYSTEM HALTED</span><br><span style="text-transform:none; font-size:10px; color:#94a3b8; font-weight:400">${err.message}</span>`;
            }
        }

        window.addEventListener('load', init);
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>